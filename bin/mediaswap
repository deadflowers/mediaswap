#!/usr/bin/env bash
# =============================================================================
# mediaswap: Unified media tool (Image, Audio, Video, Iconset, ASCII)
# Version: 1.0.0
# =============================================================================

set -u

# --- Configuration ---
DEFAULT_IMG_QUALITY=75
AUDIO_BITRATE_OPUS="256k"  # High quality default for Opus
AUDIO_BITRATE_STD="320k"   # High quality for MP3/AAC
VIDEO_CODEC_DEFAULT="libvpx-vp9" # VP9 by default
VIDEO_CRF_DEFAULT=32
VIDEO_PRESET_SPEED=2       # libaom cpu-used
USE_GPU="yes"              # Enabled by default per request

# --- Dependency Check ---
for cmd in zenity convert file ffmpeg; do
    command -v "$cmd" >/dev/null 2>&1 || { echo "Missing: $cmd"; exit 1; }
done

# --- Helpers ---
log() { printf "[%s] %s\n" "$(date +%H:%M:%S)" "$*" >&2; }

# Safe output filename (Append _1, _2 to avoid overwrite)
next_filename() {
    local file="$1"
    if [[ ! -e "$file" ]]; then echo "$file"; return; fi
    local dir filename ext i=1
    dir=$(dirname "$file")
    filename=$(basename -- "$file")
    ext="${filename##*.}"
    filename="${filename%.*}"
    while [[ -e "${dir}/${filename}_${i}.${ext}" ]]; do ((i++)); done
    echo "${dir}/${filename}_${i}.${ext}"
}

# Progress Bar Wrapper (Zenity if GUI, Text if CLI)
run_progress() {
    local title="$1"; shift
    # If running from Nautilus (no TTY), assume GUI mode
    if [ ! -t 0 ]; then
        ("$@" 2>&1) | zenity --progress --pulsate --title="MediaSwap" --text="$title" --auto-close --no-cancel
    else
        echo "-> $title"
        "$@"
    fi
}

# --- 1. IMAGE MODULE ---
mode_image() {
    local action="${1:-}"
    shift
    local files=("$@")

    # GUI Menu if no action provided
    if [[ -z "$action" || -f "$action" ]]; then
        [[ -f "$action" ]] && files=("$action" "${files[@]}")
        action=$(zenity --list --title="Image Tools" --height=450 --width=400 \
            --column="Action" --column="Description" \
            "webp" "Convert to WebP" \
            "png" "Convert to PNG" \
            "jpg" "Convert to JPG" \
            "bevel" "Add transparent bevel" \
            "rappleshot" "Add shadow (Rappleshot)" \
            "bgremove" "Remove background (Select color)" \
            "iconset" "Generate Iconset folder" \
            "ascii" "Convert to ASCII (chafa)" \
            "strip" "Scrub Metadata (Same format)") || exit 0
    fi

    for f in "${files[@]}"; do
        [ ! -f "$f" ] && continue
        local dir base ext out
        dir=$(dirname "$f")
        base=$(basename "${f%.*}")
        ext="${f##*.}"

        case "$action" in
            webp)
                out=$(next_filename "${dir}/${base}.webp")
                run_progress "To WebP: $base" convert "$f" -quality "$DEFAULT_IMG_QUALITY" "$out"
                ;;
            jpg|jpeg)
                out=$(next_filename "${dir}/${base}.jpg")
                run_progress "To JPG: $base" convert "$f" -quality "$DEFAULT_IMG_QUALITY" -background white -flatten "$out"
                ;;
            png)
                out=$(next_filename "${dir}/${base}.png")
                run_progress "To PNG: $base" convert "$f" "$out"
                ;;
            bevel)
                # Transparent border + Raise (No grey center artifact)
                out=$(next_filename "${dir}/${base}_bevel.png")
                run_progress "Beveling: $base" convert "$f" -alpha set -bordercolor none -border 16 -raise 16 "$out"
                ;;
            rappleshot)
                out=$(next_filename "${dir}/${base}_rapple.png")
                run_progress "Shadowing: $base" convert "$f" \( +clone -background black -shadow 80x20+0+15 \) +swap -background transparent -layers merge +repage "$out"
                ;;
            bgremove)
                # Interactive aggressiveness if GUI
                local fuzz="15"
                if [ ! -t 0 ]; then fuzz=$(zenity --scale --title="Aggressiveness" --value=15 --max-value=50); fi
                out=$(next_filename "${dir}/${base}_nobg.png")
                run_progress "Removing BG: $base" convert "$f" -alpha on -fuzz "${fuzz}%" -transparent white "$out"
                ;;
            iconset)
                local idir="${dir}/${base}_iconset"
                mkdir -p "$idir"
                run_progress "Generating Iconset: $base" bash -c "
                    convert \"$f\" -resize 16x16 \"$idir/16.png\"
                    convert \"$f\" -resize 32x32 \"$idir/32.png\"
                    convert \"$f\" -resize 48x48 \"$idir/48.png\"
                    convert \"$f\" -resize 128x128 \"$idir/128.png\"
                    convert \"$f\" -resize 256x256 \"$idir/256.png\"
                    convert \"$f\" -resize 512x512 \"$idir/512.png\"
                    convert \"$idir/16.png\" \"$idir/32.png\" \"$idir/48.png\" \"$idir/favicon.ico\"
                "
                ;;
            ascii)
                if command -v chafa >/dev/null; then
                   chafa "$f" > "${dir}/${base}.txt"
                elif command -v jp2a >/dev/null; then
                   jp2a "$f" > "${dir}/${base}.txt"
                fi
                ;;
            strip)
                out=$(next_filename "${dir}/${base}_clean.${ext}")
                if command -v exiftool >/dev/null; then
                    cp "$f" "$out" && exiftool -overwrite_original -all= "$out"
                else
                    convert "$f" -strip "$out"
                fi
                ;;
        esac
    done
}

# --- 2. AUDIO MODULE ---
mode_audio() {
    local action="${1:-}"
    shift
    local files=("$@")

    if [[ -z "$action" || -f "$action" ]]; then
        if [[ -f "$action" ]]; then files=("$action" "${files[@]}"); fi
        action=$(zenity --list --title="Audio Tools" --height=300 --width=400 \
            --column="Action" --column="Desc" \
            "opus" "To Opus (High Quality)" \
            "m4a" "To AAC/M4A (320k)" \
            "mp3" "To MP3 (320k)" \
            "flac" "To FLAC (Lossless)" \
            "rip" "Rip Audio (Copy if possible)") || exit 0
    fi

    for f in "${files[@]}"; do
        [ ! -f "$f" ] && continue
        local dir base out
        dir=$(dirname "$f")
        base=$(basename "${f%.*}")

        case "$action" in
            opus)
                out=$(next_filename "${dir}/${base}.opus")
                run_progress "Encoding Opus..." ffmpeg -y -i "$f" -c:a libopus -b:a "$AUDIO_BITRATE_OPUS" -vn "$out"
                ;;
            m4a)
                out=$(next_filename "${dir}/${base}.m4a")
                run_progress "Encoding AAC..." ffmpeg -y -i "$f" -c:a aac -b:a "$AUDIO_BITRATE_STD" -vn "$out"
                ;;
            mp3)
                out=$(next_filename "${dir}/${base}.mp3")
                run_progress "Encoding MP3..." ffmpeg -y -i "$f" -c:a libmp3lame -b:a "$AUDIO_BITRATE_STD" -vn "$out"
                ;;
            flac)
                out=$(next_filename "${dir}/${base}.flac")
                run_progress "Encoding FLAC..." ffmpeg -y -i "$f" -c:a flac -vn "$out"
                ;;
            rip)
                # Try copy first; fallback to transcode
                out=$(next_filename "${dir}/${base}.mka")
                if ! ffmpeg -y -i "$f" -c:a copy -vn "$out" >/dev/null 2>&1; then
                    out=$(next_filename "${dir}/${base}.opus")
                    run_progress "Rip (transcoding)..." ffmpeg -y -i "$f" -c:a libopus -b:a 192k -vn "$out"
                fi
                ;;
        esac
    done
}

# --- 3. VIDEO MODULE ---
mode_video() {
    local action="${1:-}"
    shift
    local files=("$@")

    if [[ -z "$action" || -f "$action" ]]; then
        if [[ -f "$action" ]]; then files=("$action" "${files[@]}"); fi
        action=$(zenity --list --title="Video Tools" --height=350 --width=400 \
            --column="Action" --column="Desc" \
            "vp9" "To WebM (VP9)" \
            "av1" "To WebM (AV1)" \
            "h264" "To MP4 (H.264)" \
            "prores" "To ProRes (Edit friendly)" \
            "rip" "Rip Audio Only") || exit 0
    fi

    # GPU Check
    local vcodec="$VIDEO_CODEC_DEFAULT"
    if [ "$USE_GPU" = "yes" ]; then
        case "$action" in
            h264) vcodec="h264_nvenc" ;;
            h265) vcodec="hevc_nvenc" ;;
        esac
    fi

    for f in "${files[@]}"; do
        [ ! -f "$f" ] && continue
        local dir base out
        dir=$(dirname "$f")
        base=$(basename "${f%.*}")

        case "$action" in
            vp9)
                out=$(next_filename "${dir}/${base}.webm")
                run_progress "VP9 Encoding..." ffmpeg -y -i "$f" -c:v libvpx-vp9 -crf "$VIDEO_CRF_DEFAULT" -b:v 0 -c:a libopus "$out"
                ;;
            av1)
                out=$(next_filename "${dir}/${base}.webm")
                run_progress "AV1 Encoding..." ffmpeg -y -i "$f" -c:v libaom-av1 -crf 30 -b:v 0 -cpu-used 4 -c:a libopus "$out"
                ;;
            h264)
                out=$(next_filename "${dir}/${base}.mp4")
                # Uses GPU if enabled above, else CPU default libx264
                if [ "$vcodec" = "h264_nvenc" ]; then
                     run_progress "H264 (GPU)..." ffmpeg -y -i "$f" -c:v h264_nvenc -c:a copy "$out"
                else
                     run_progress "H264 (CPU)..." ffmpeg -y -i "$f" -c:v libx264 -crf 23 -c:a copy "$out"
                fi
                ;;
            prores)
                out=$(next_filename "${dir}/${base}.mov")
                run_progress "ProRes..." ffmpeg -y -i "$f" -c:v prores_ks -profile:v 3 -c:a pcm_s16le "$out"
                ;;
            rip)
                # Audio rip logic reuse
                out=$(next_filename "${dir}/${base}.mka")
                ffmpeg -y -i "$f" -c:a copy -vn "$out"
                ;;
        esac
    done
}

# --- Dispatcher ---
MODE="${1:-}"
shift || true

case "$MODE" in
    i|img|image) mode_image "$@" ;;
    a|aud|audio) mode_audio "$@" ;;
    v|vid|video) mode_video "$@" ;;
    *)
        # Fallback detection or help
        echo "Usage: mediaswap [i|a|v] [action] [files...]"
        exit 1
        ;;
esac
